#! /usr/bin/env node
'use strict';


const co = require('co');
const home = require('fie-home');
const fieError = require('fie-error');
const fieUpgrade = require('fie-upgrade');
const log = require('fie-log')('fie-core');
const fieCommands = require('fie-commands');
const argv = require('fie-argv');
const sudoBlock = require('sudo-block');
const initEnv = require('../lib/init-env');
const fiePkg = require('../package.json');

// 禁止 sudo 执行 fie 命令
sudoBlock();

/**
 * 初始化开发环境
 * @param obj
 */
function initConfig(obj) {
  Object.keys(obj).forEach(item => {
    if(!process.env[item]){
      process.env[item] = obj[item];
    }
  })
}

/**
 * 所有 fie 命令的入口，整体架构请见： https://img.alicdn.com/tfs/TB1HBbHRFXXXXXHaXXXXXXXXXXX-1596-1118.png
 */
co(function* () {

  log.debug('app start run ....');

  // 运行前的一些初始化配置工作，这些内容将存于fie的运行时
  initConfig({
    FIE_VERSION : fiePkg.version,
    FIE_PACKAGE : fiePkg.name,
    FIE_MODULE_PREFIX : 'lzd',
    FIE_CONFIG_FILE : 'lzd.config.js',
    FIE_HOME_FOLDER : '.lzd'
  });

  // fie 家目录存在性检查
  home.initHomeDir();
  // 检测环境是否已初始化
  yield initEnv();
  // fie版本更新提示
  yield fieUpgrade({
    name : fiePkg.name,
    version : fiePkg.version
  });

  //fie 核心运行命令
  const coreCommands = Object.keys(fieCommands).filter( (item) =>{
    return item !== 'main';
  });

  const fieArgv = argv();
  const command = fieArgv.command;
  const newArgv = fieArgv.argv;

  if (coreCommands.indexOf(command) === -1) {
    log.debug('进入套件,插件分支');
    yield fieCommands.main.apply(this, [command, newArgv]);
  } else {
    log.debug('进入核心命令分支');
    // init, install, install, uninstall, update ,version 等命令
    // 对 fie.config.js 没有依赖, 也不考虑兼容旧版, 也不执行自定义命令流
    yield fieCommands[command].apply(null, [newArgv]);
  }

  // 捕获异常
  process.on('uncaughtException', (err) => {
    log.debug(`进入未知错误${JSON.stringify(err)}`);
    fieError.handle(err);
  });
}).catch((err) => {
  fieError.handle(err);
});
